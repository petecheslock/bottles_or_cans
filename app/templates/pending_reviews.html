{% extends 'base.html' %}

{% block content %}
<!-- Include the modal component at the top of the template -->
{% include 'components/confirm_modal.html' %}

<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Pending Reviews</h1>
            <a href="{{ url_for('admin.dashboard') }}" 
               class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg 
                      hover:-translate-y-0.5 transition-all duration-300">
                <i class="bi bi-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="p-4 mb-4 rounded-lg {% if category == 'success' %}bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-200{% else %}bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200{% endif %} flex justify-between items-center animate__animated animate__fadeIn">
                        {{ message }}
                        <button type="button" class="text-lg font-semibold" onclick="this.parentElement.remove()">Ã—</button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-900">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Review</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Submitted</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {% for review in pending_reviews %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-normal">
                                    <div class="text-sm text-gray-900 dark:text-gray-200">{{ review.text }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 dark:text-gray-200">
                                        {{ review.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <form action="{{ url_for('admin.approve_pending', review_id=review.id) }}" 
                                          method="POST" 
                                          class="inline">
                                        <button type="submit" 
                                                class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    </form>
                                    <form action="{{ url_for('admin.reject_pending', review_id=review.id) }}" 
                                          method="POST" 
                                          class="inline">
                                        <button type="submit"
                                                class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add this script at the bottom of the template -->
<script>
function showRejectConfirmation(reviewId) {
    // First show the modal
    showConfirmModal(
        reviewId,
        'reject',
        'Confirm Rejection',
        'Are you sure you want to reject this review?'
    );

    // Wait for a brief moment to ensure modal is rendered
    setTimeout(() => {
        // Get modal elements with error checking
        const modalConfirm = document.getElementById('confirmAction');
        if (!modalConfirm) {
            console.error('Could not find confirm button');
            return;
        }

        // Clone and replace the confirm button
        const newModalConfirm = modalConfirm.cloneNode(true);
        modalConfirm.parentNode.replaceChild(newModalConfirm, modalConfirm);

        // Add the click handler
        newModalConfirm.addEventListener('click', function() {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('admin.pending_reviews') }}";
            form.innerHTML = `
                <input type="hidden" name="review_id" value="${reviewId}">
                <input type="hidden" name="action" value="reject">
            `;
            document.body.appendChild(form);
            form.submit();
        });

        // Add keyboard support
        function handleKeyPress(e) {
            if (e.key === 'Enter' && !document.getElementById('confirmModal').classList.contains('hidden')) {
                newModalConfirm.click();
                document.removeEventListener('keydown', handleKeyPress);
            }
        }

        document.addEventListener('keydown', handleKeyPress);
    }, 100);
}

// Remove old event listeners since we're handling everything in showRejectConfirmation now
</script>
{% endblock %}