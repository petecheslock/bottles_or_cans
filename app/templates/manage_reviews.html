d{% extends 'base.html' %}

{% block content %}
<!-- Include the modal component at the top of the template -->
{% include 'components/confirm_modal.html' %}

<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Manage Reviews</h1>
            <a href="{{ url_for('admin.dashboard') }}" 
               class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg 
                      hover:-translate-y-0.5 transition-all duration-300">
                <i class="bi bi-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="p-4 mb-4 rounded-lg {% if category == 'success' %}bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-200{% else %}bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200{% endif %} flex justify-between items-center animate__animated animate__fadeIn">
                        {{ message }}
                        <button type="button" class="text-lg font-semibold" onclick="this.parentElement.remove()">√ó</button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-900">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Review</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Votes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {% for review in reviews %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-normal">
                                    <div class="text-sm text-gray-900 dark:text-gray-200">{{ review.text }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 dark:text-gray-200">
                                        üéß {{ review.votes_headphones }} | üç∑ {{ review.votes_wine }}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <a href="{{ url_for('admin.edit_review', review_id=review.id) }}" 
                                       class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <button onclick="handleResetVotes({{ review.id }})" 
                                            class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                    <form action="{{ url_for('admin.delete_review', review_id=review.id) }}" 
                                          method="POST" 
                                          class="inline"
                                          onsubmit="return confirm('Are you sure you want to delete this review?')">
                                        <button type="submit" 
                                                class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function handleResetVotes(reviewId) {
    const modalMessage = document.getElementById('modalMessage');
    const modalFooter = document.querySelector('#confirmModal .flex.justify-end');
    const originalButtons = modalFooter.innerHTML;
    
    // Replace buttons with a disabled "Working..." button
    modalFooter.innerHTML = `
        <button type="button" 
                disabled
                class="w-full px-4 py-2 bg-gray-400 dark:bg-gray-600 text-white rounded-lg transition-colors duration-200 cursor-not-allowed">
            Working...
        </button>
    `;
    
    // Show loading state with rotating spinner
    modalMessage.innerHTML = `
        <div class="flex items-center justify-center">
            <i class="bi bi-arrow-repeat text-xl mr-2 animate-spin"></i>
            <span>Resetting vote counts to zero...</span>
        </div>
    `;

    // Start timing when we begin the fetch
    const startTime = Date.now();
    const minimumLoadingTime = 2000; // 2 seconds minimum loading time

    fetch(`/admin/reset-votes/${reviewId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const elapsedTime = Date.now() - startTime;
            const remainingTime = Math.max(0, minimumLoadingTime - elapsedTime);

            setTimeout(() => {
                modalMessage.innerHTML = `
                    <div class="flex items-center justify-center text-green-600 dark:text-green-400">
                        <i class="bi bi-check-circle mr-2 text-xl"></i>
                        <span>Vote counts have been reset successfully!</span>
                    </div>
                `;
                // Replace working button with a disabled "Success!" button
                modalFooter.innerHTML = `
                    <button type="button" 
                            disabled
                            class="w-full px-4 py-2 bg-green-500 dark:bg-green-600 text-white rounded-lg transition-colors duration-200 cursor-not-allowed">
                        Success!
                    </button>
                `;
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }, remainingTime);
        } else {
            modalMessage.innerHTML = `
                <div class="text-red-600 dark:text-red-400">
                    <i class="bi bi-exclamation-triangle mr-2"></i>
                    Error: ${data.message || 'Failed to reset votes'}
                </div>
            `;
            // Restore original buttons on error
            modalFooter.innerHTML = originalButtons;
        }
    })
    .catch(error => {
        modalMessage.innerHTML = `
            <div class="text-red-600 dark:text-red-400">
                <i class="bi bi-exclamation-triangle mr-2"></i>
                Error: ${error.message || 'Failed to reset votes'}
            </div>
        `;
        // Restore original buttons on error
        modalFooter.innerHTML = originalButtons;
    });
}

function handleSeedVotes() {
    const modalMessage = document.getElementById('modalMessage');
    const modalFooter = document.querySelector('#confirmModal .flex.justify-end');
    const originalButtons = modalFooter.innerHTML;
    
    // Replace buttons with a disabled "Working..." button
    modalFooter.innerHTML = `
        <button type="button" 
                disabled
                class="w-full px-4 py-2 bg-gray-400 dark:bg-gray-600 text-white rounded-lg transition-colors duration-200 cursor-not-allowed">
            Working...
        </button>
    `;
    
    // Show loading state with rotating spinner
    modalMessage.innerHTML = `
        <div class="flex items-center justify-center">
            <i class="bi bi-arrow-repeat text-xl mr-2 animate-spin"></i>
            <span>Seeding random votes...</span>
        </div>
    `;

    const startTime = Date.now();
    const minimumLoadingTime = 2000;

    fetch('{{ url_for("admin.seed_reviews") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const elapsedTime = Date.now() - startTime;
            const remainingTime = Math.max(0, minimumLoadingTime - elapsedTime);

            setTimeout(() => {
                modalMessage.innerHTML = `
                    <div class="flex items-center justify-center text-green-600 dark:text-green-400">
                        <i class="bi bi-check-circle mr-2 text-xl"></i>
                        <span>Random votes have been seeded successfully!</span>
                    </div>
                `;
                modalFooter.innerHTML = `
                    <button type="button" 
                            disabled
                            class="w-full px-4 py-2 bg-green-500 dark:bg-green-600 text-white rounded-lg transition-colors duration-200 cursor-not-allowed">
                        Success!
                    </button>
                `;
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }, remainingTime);
        } else {
            modalMessage.innerHTML = `
                <div class="text-red-600 dark:text-red-400">
                    <i class="bi bi-exclamation-triangle mr-2"></i>
                    Error: ${data.message || 'Failed to seed votes'}
                </div>
            `;
            modalFooter.innerHTML = originalButtons;
        }
    })
    .catch(error => {
        modalMessage.innerHTML = `
            <div class="text-red-600 dark:text-red-400">
                <i class="bi bi-exclamation-triangle mr-2"></i>
                Error: ${error.message || 'Failed to seed votes'}
            </div>
        `;
        modalFooter.innerHTML = originalButtons;
    });
}

// Update the click handler to include the seed action and keyboard support
document.addEventListener('DOMContentLoaded', function() {
    const confirmButton = document.getElementById('confirmAction');
    const oldConfirmButton = confirmButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(oldConfirmButton, confirmButton);
    
    oldConfirmButton.addEventListener('click', function() {
        if (currentAction === 'reset') {
            handleResetVotes(currentReviewId);
        } else if (currentAction === 'seed') {
            handleSeedVotes();
        } else if (currentAction === 'delete' && currentFormId) {
            document.getElementById(`deleteForm-${currentFormId}`).submit();
            hideConfirmModal();
        }
    });

    // Add keyboard support for Enter key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !document.getElementById('confirmModal').classList.contains('hidden')) {
            if (currentAction === 'reset') {
                handleResetVotes(currentReviewId);
            } else if (currentAction === 'seed') {
                handleSeedVotes();
            } else if (currentAction === 'delete' && currentFormId) {
                document.getElementById(`deleteForm-${currentFormId}`).submit();
                hideConfirmModal();
            }
        }
    });
});
</script>
{% endblock %}